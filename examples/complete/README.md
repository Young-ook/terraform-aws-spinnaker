# Full example of spinnaker module for aws

## Usage
You can use this module like below. This shows how to create the resources for spinnaker.
This module will create vpc, subnets, s3 bucket, iam policies and kubernetes cluster.

### Initialise
This is the first step to create a spinnaker cluster. Just get terraform module and apply it with your custom variables. These are terraform commands, `terraform init`, `terraform plan -var-file default.tfvars`, and `terraform apply -var-file default.tfvars`. After then you will see so many resources like eks, s3, ec2, iam, rds, and others on aws.

#### Quickstart
```
module "spinnaker" {
  source  = "Young-ook/spinnaker/aws"
  version = "2.0.0"

  name    = "spinnaker"
  stack   = "preprod"
  tags    = { "env" = "preprod" }
  region  = "us-east-1"
  azs     = ["us-east-1a","us-east-1b","us-east-1c"]
}
```

#### Complete example
```
module "spinnaker" {
  source  = "Young-ook/spinnaker/aws"
  version = "2.0.0"

  name                    = "spinnaker"
  stack                   = "preprod"
  detail                  = "wow"
  tags                    = { "env" = "preprod" }
  region                  = "us-east-1"
  azs                     = ["us-east-1a", "us-east-1b", "us-east-1c"]
  cidr                    = "10.51.0.0/16"
  kube_version            = "1.16"
  kube_node_type          = "t3.medium"
  kube_node_size          = "3"
  kube_node_vol_size      = "100"
  mysql_version           = "5.7.12"
  mysql_port              = "3939"
  mysql_node_type         = "db.t3.medium"
  mysql_node_size         = "1"
  mysql_master_user       = "youruser"
  mysql_db                = "yourdb"
  mysql_snapshot          = "yourrds-snapshot"
  mysql_apply_immediately = false
  dns_zone                = "yourapp.internal"
  helm_chart_version      = "2.0.0-rc9"
  helm_chart_values       = [file("helm-values.yml")]
}
```

### Update the trusted relationship
After you've done previous step to lanuch a spinnaker, you can now start to integrate with other aws accounts as `spinnaker managed` to make them to be managed by your spinnaker. Here is the [terrform module](https://github.com/tf-mod/terraform-aws-spinnaker-managed-role/tree/master/examples/complete). It will help you to convert your aws account to be controll by the spinnaker. Back to this example when you've applied `spinnaker-managed-role` module to your target aws account you must add the ARN which is generated by the `spinnaker-managed-role` template into `assume_role_arn` variable.

```
module "spinnaker-managed-role" {
  source  = "Young-ook/spinnaker-managed-role/aws"
  version = "1.0.2"

  desc             = "preprod"
  trusted_role_arn = ["arn:aws:iam::1234567890321:role/spinnaker-managed-your-env"]
}
```

### Update the spinnaker role
Don't forget you have to add the spinnaker managed role to `assume_role_arn` list of spinnaker terraform module, because spinnaker application needs a permission to access the target aws accounts via assume role API using AWS SDK.
```
module "spinnaker" {
  source  = "Young-ook/spinnaker/aws"
  version = "2.0.0"

  ...

  assume_role_arn = [module.spinnaker-managed-role.role_arn]
}
```

### Generate kubernetes config
This terraform module will give you a shell script to get kubeconfig file of an EKS cluster. You will find the [update-kubeconfig.sh](https://github.com/Young-ook/terraform-aws-spinnaker/tree/master/script/update-kubeconfig.sh) script in the `script` directory of this repository. You can get the kubeconfig file with credentials to access your EKS cluster using this script. For more detail of how to use this, please refer to the help message of the script.

[Important] Before you run this script you must configure your local environment to have proper permission to get the credentials from EKS cluster on your aws account whatever you are using aws cli or aws-vault.
