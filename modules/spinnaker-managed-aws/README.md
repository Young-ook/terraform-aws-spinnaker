# Spinnaker Managed AWS
[Spinnaker](https://spinnaker.io/) is an open-source, multi-cloud continuous delivery platform for releasing software changes with high velocity and confidence. This is a terraform module for an IAM role for Spinnaker to control your AWS account. In other words, it helps you convert your AWS account to be controlled by the spinnaker. This module will create an IAM role on your AWS account and the role name will be similar to the following, `<name>-<stack>-<detail>-spinnaker-managed`. At the end, you can integrate this role with the Spinnaker. For more information, please follow the instructions below.

## Quickstart
### Setup
```hcl
module "spinnaker-managed" {
  source           = "Young-ook/spinnaker/aws//modules/spinnaker-managed-aws"
  version          = ">= 2.0"
  name             = "example"
  trusted_role_arn = ["arn:aws:iam::1234567890321:role/spinnaker-test-xgsj"]
}
```
Run terraform:
```
terraform init
terraform apply
```

## Update the trusted relationship
### Create a spinnaker managed role
After you've done previous step to lanuch a spinnaker, you will see the generated IAM roles and policies. Then, you can now start to integrate with an AWS account as `spinnaker managed` to make it to be managed by your spinnaker. Back to the terraform configuration file after applying the `spinnaker-managed` module on your target AWS account, and add the ARN you've generated by the `spinnaker-managed` into the `assume_role_arn` variable of spinnaker. For more details, please refer to the **Update the spinnaker role** below.

### Update the spinnaker role
After applying `spinnaker-managed-aws` submodule, you will get an ARN of IAM role from output variable. It may look like `arn:aws:iam::012345678912:role/example-spinnaker-managed`. Don't forget you have to add the spinnaker managed role to `assume_role_arn` list of spinnaker terraform module, because spinnaker application needs a permission to access the target AWS accounts via assume role API using AWS SDK. Here is an example to show how to link the spinnaker managed roles to spinnaker role.
```hcl
module "spinnaker" {
  source          = "Young-ook/spinnaker/aws"
  version         = "~> 2.0"
  ...

  assume_role_arn = [module.spinnaker-managed.role_arn]
}
```

## Enabling AWS account in spinnaker
To enable AWS account in the spinnaker, you have to access the halyard pod using `kubectl` command.
```
kubectl -n spinnaker exec -it cd-spinnaker-halyard-0 -- bash
bash $ hal config provider aws account add aws-test \
    --account-id '0123456879031' \
    --assume-role role/spinnaker-test-xgsj \
    --regions us-east-1, us-west-2
bash $ hal config provider aws enable
bash $ hal deploy apply
```
After you configure the Spinnaker AWS provider you can manage AWS resources depending on what you included in the AWS policy. You would be able to deploy EC2 resources with Spinnaker.
