# Example of spinnaker on aws

## Usage
You can use this module like as below. This shows how to create the resources for spinnaker.
This module will create vpc, subnets, s3 bucket, iam policies and kubernetes cluster.

### Initialise
This is the first step to create a spinnaker cluster. Just get terraform module and apply it and this is sort of terraform command to do `terraform init`, `terraform plan -var-file default.tfvars`, and `terraform apply -var-file default.tfvars`. After then you will see so many resources like eks, s3, ec2, iam, rds, and others on aws.

#### Easy and simple example
```
module "spinnaker" {
  source               = "git::git@github.com:Young-ook/terraform-aws-spinnaker.git?ref=1.0.0"
  name                 = "spinnaker"
  stack                = "preprod"
  tags                 = { "env" = "preprod" }
  region               = "us-east-1"
  azs                  = ["us-east-1a","us-east-1b","us-east-1c"]
}
```

#### Complete example
```
module "spinnaker" {
  source                  = "git::git@github.com:Young-ook/terraform-aws-spinnaker.git?ref=1.0.0"
  name                    = "spinnaker"
  stack                   = "preprod"
  detail                  = "wow"
  tags                    = { "env" = "preprod" }
  region                  = "us-east-1"
  azs                     = ["us-east-1a", "us-east-1b", "us-east-1c"]
  cidr                    = "10.51.0.0/16"
  kube_version            = "1.16"
  kube_node_type          = "t3.medium"
  kube_node_size          = "3"
  kube_node_vol_size      = "100"
  mysql_version           = "5.7.12"
  mysql_port              = "3939"
  mysql_node_type         = "db.t3.medium"
  mysql_master_user       = "youruser"
  mysql_db                = "yourdb"
  mysql_snapshot          = "yourrds-snapshot"
  mysql_apply_immediately = false
  dns_zone                = "app.internal"
}
```

### Update the trusted relationship
After you've done previous step to lanuch a spinnaker you can now start to integrate with other aws accounts as `spinnaker managed` to make them to be managed by your spinnaker. Here is the terrform module to help you transform your aws account(https://github.com/Young-ook/terraform-aws-spinnaker-managed-role). Back to this example when you've applied `spinnaker-managed-role` module to your target aws account you must add the ARN which is generated by the `spinnaker-managed-role` template into `assume_role_arn` variable.

```
module "spinnaker" {
  source               = "git::git@github.com:Young-ook/terraform-aws-spinnaker.git?ref=1.0.0"
  name                 = "spinnaker"
  stack                = "preprod"
  ...

  assume_role_arn      = ["arn:aws:iam::1234567890321:role/spinnaker-managed-your-env"]
}
```

### Generate minified kubernetes config
This terraform module will automatically generate shell script to get minified kubeconfig file. You will find the `update-kubeconfig.sh` script in the current working directory. When you get minified config file successfully you will have permission to control or manage the whole resources in `spinnaker` namespace.

[Important] Before you run this script you must configure your local environment to have proper permission to make a change on target aws account whatever you are using aws cli or aws-vault. Or it might be `default` when you didn't fill in anything. In this case you have to prepare aws credentials as default profile in `~/.aws/credentials` file.

`$ bash update-kubeconfig.sh`
